---
title: "Caribou Demographi Projection - interesting & informative title TBD"
author:
  - name: Josie Hughes
    email: josie.hughes@ec.gc.ca
    institute: [ECCC]
    correspondence: true
  - name: Sarah Endicott
    email: sarah.endicott@ec.gc.ca
    institute: [ECCC]
    correspondence: false
  - name: Cheryl A Johnson
    email: cheryl-ann.johnson@ec.gc.ca
    institute: [ECCC]
    correspondence: false
institute:
  - ECCC: Environment and Climate Change Canada 
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
    bookdown::word_document2:
      fig_caption: yes
      number_sections: no
      reference_docx: "../templates/template.docx" # Insert path for the DOCX file
      pandoc_args:
      - --lua-filter=../templates/scholarly-metadata.lua
      - --lua-filter=../templates/author-info-blocks.lua
      - --lua-filter=../templates/pagebreak.lua
bibliography: CaribouDemographicModel.bib
csl: "../templates/journal-of-forest-ecology-and-management.csl" # Insert path for the bib-style
abstract: |
  Text of abstract
keywords: |
  keyword 1; keyword 2; keyword 3
highlights: |
  These are the highlights. 
editor_options: 
  chunk_output_type: inline
---

<!-- This is the format for text comments that will be ignored during renderings. Do not put R code in these comments because it will not be ignored. -->

<!-- With the following code you can access and display values from the yml header above. -->
<!-- Link to data here: https://drive.google.com/file/d/179lw6MPK4l3xGmded9kofzJkB6VlJVb9/view?usp=sharing -->

Keywords: `r rmarkdown::metadata$keywords`

Highlights: `r rmarkdown::metadata$highlights`

<!-- The following code chunk defines some general settings how code chunks should behave. -->

```{r setup, echo = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  echo = FALSE,
  comment = "#>",
  fig.path = "../figures/",
  dpi = 300
)
```

<!-- The actual document text starts here: -->

# Introduction

Motivating example - forecasting impacts of disturbance - WBI and RoF example. In order to reduce uncertainty, need to integrate local information on current state of the population into forecasts.

In Mississa (and other places) available local data is old and limited. Not clear how indicative older data is of state of population. Need new data to resolve questions, but what type, how much is enough. Can't monitor in great detail everywhere all the time. More generally, need for tools to help assess the value of additional monitoring, given the info that is already available. 

Topics of interest, questions, goals:

* How get a demographic forecast informed by local demographic data and national disturbance-demographic relationships?
* How to assess the value of collecting additional demographic data? 
* How does that value depend on current status of the range, available existing demographic data, and projected future disturbance. When and why is more information required, and when do we know enough?
* Provide decision support tools to enable others to get forecasts informed by their local data and national models, and assess the value of monitoring scenarios. 

# Methods

```{r setup2}
library(ggplot2)
library(dplyr)
library(stringr)
library(tidyr)
library(purrr)
library(ggpubr)
library(MetBrewer)
library(here)
library(tmap)
library(sf)

devtools::load_all(here::here())

#set paths
data_path_raw <- "analysis/data/raw_data/"
data_path_drvd <- "analysis/data/derived_data"
app_path <- "C:/Users/HughesJo/Documents/gitprojects/BayesianCaribouDemographicProjection"

pal_nm <- "Redon"

fig_widths <- c(min = 1.18, single = 3.543, mid = 5.51, two = 7.48)

runScenarios =T 
```
TO DO: build large table of all parameters as the various sections are written. Adjust UI for consistent terminology along the way.

## A simple Bayesian IPM to integrate local demographic data and national disturbance-demographic relationships

Following [@eacker_web-based_2019], the observed number of calves $c_t$ is a binomially distributed function of the observed number of adult female caribou $a_t$ and the estimated recruitment probability $R_t$: $$c_t \sim R_t^{c_t}(1-R_t)^{a_t-c_t}.$$
We model recruitment probability as a function of anthropogenic disturbance and fire [@johnson_science_2020;@stewart_climate-informed_nodate;@dyson_existing_2022], with a log link and Gaussian distributed random year effect [@eacker_web-based_2019]: $$\log(R_t)=\beta^R_0+\beta^R_a anthro_t+\beta^R_f fireExclAnthro_t+\epsilon^R_t; \epsilon^R_t \sim \text{normal}(0,\sigma^2_{R}).$$ 
Estimated recruitment probability is adjusted for sex ratio and delayed age of first reproduction [@eacker_web-based_2019;@decesare_estimating_2012] to get expected recruits per female: $$\tilde{R}_t=\frac{R_t/2}{1+R_t/2}.$$

Also following [@eacker_web-based_2019], Kaplan-Meier estimates of observed adult female survival probability $\hat{S}_t$ and associated precisions $\tau_t$ are estimated from known-fate radio collar data using the survival R package [@therneau_modeling_2000], with precisions for years with no observed mortality estimated using a separate Bayesian model. Observed estimated survival is a Gaussian distributed function of the true survival probability: $$\hat{S_t} \sim \text{normal}(S_t,1/\tau_t).$$ 
We model true survival probability as an adjusted function of anthropogenic disturbance  [@johnson_science_2020;@stewart_climate-informed_nodate;@dyson_existing_2022], with a log link and Gaussian distributed random year effect [@eacker_web-based_2019]: $$S_t=\text{min}(46 \tilde{S_t}-0.5)/45,1); \log(\tilde{S_t})=\beta^S_0+\beta^S_a anthro_t+\epsilon^S_t; \epsilon^S_t \sim \text{normal}(0,\sigma^2_{S}).$$ 
To assess sensitivity of results to the survival estimation method, we also implemented an alternative parametric exponential survival model, wherein the state of an individual animal in year $t$ and month $m$ is Bernoulli distributed (ref IPM book): $$A_{t,m} \sim \text{Bernoulli}(S^{1/12}_t A_{t,m-1}).$$

All regression coefficients are assumed to be Gaussian distributed, with priors derived from the expected values and 95% confidence intervals estimated by Johnson et al (2020) (Table \@ref(tab:priors)). We calibrated the prior distributions so that the 95% prediction interval from the IPM matches the range between the 2.5% and 97.5% quantiles of 1000 simulated recruitment (Supplement X).  

```{r priors, echo=FALSE}

source(here::here("analysis/scripts/formatPriors.R"))

knitr::kable(tbl,caption="Model priors parameters are Gaussian distributed with expected values ")
```

TO DO: 

* ensure that INF_saf_INF_r_JAGS_extentTime.txt and INF_saf_INF_r_JAGS_expSurvival2.txt are identical except for the survival observation model. Or better yet, write code to sub in correct survival model more elegantly.
* note various bits of truncation in the JAGS code to ensure R and S remain between 0 and 1 (not guaranteed given log link). Not all documented in this explanation. Bayesian wizard might know a better way. Or at least know how to explain.
* note Eacker survival method gives biased results in years when <12 months of survival data is available.
* Note I am dropping survival information for animals that are not alive at the beginning of a year to deal with censoring issues. There is probably some more elegant way to deal with this, but it won't make any difference as long as the collar deployment month is set to 1.
* add references to documentation of popGrowthJohnson and other caribouMetrics functions.

Note alternative exponential survival analysis method - put results in appendix, show it doesn't make much difference.

## Calibrating to results from national model 

Explain method for selecting values for remaining priors

Write for now assuming that caribouMetrics paper will be published somewhere.

## A method for simulating example data

### True population dynamics
Write for now assuming that caribouMetrics paper will be published somewhere.

### Observed survival from collars

### Observed recruitment from calf:cow aerial surveys


## Assessing the value of information

TO DO: how to assess or quantify value in this context. Power to distinguish increasing from decreasing population? What else?

## Scenarios

Table 1. Example ranges. Ontario demographic information from [@mnrf_state_2014]. If two numbers given for Anthropogenic disturbance they are BEAD 2010 and 2015.

```{r}
tbl <- "Range|Anthropogenic Disturbance|$\\lambda$|R|S|Survey Years
Missisa|0.41|0.86|14.2|80%|2008-2012
Churchill||0.96|19.5|87%|2011-2012
"
df <- read.delim(textConnection(tbl),header=FALSE,sep="|",strip.white=TRUE,stringsAsFactors=FALSE)
names(df) <- unname(as.list(df[1,]))
df <- df[-1,] # remove first row
row.names(df)<-NULL
knitr::kable(df)
```
TO DO: id examples from elsewhere to complement Ontario examples. Would be good to include an example where status is ok. What else, and why? WBI NWT ranges?

NOTE: would be great to info on number of collars per year in each example range. Though note MNRF recruitment estimates in some years came from aerial distribution surveys.

Table 2. Monitoring scenarios adapted from [@rettie_summary_2017].
```{r}
tbl <- "Years|Initial collars|Min collars|cow multiplier|collaring month|collar duration
3|25|25|3|1|3
"
df <- read.delim(textConnection(tbl),header=FALSE,sep="|",strip.white=TRUE,stringsAsFactors=FALSE)
names(df) <- unname(as.list(df[1,]))
df <- df[-1,] # remove first row
row.names(df)<-NULL
knitr::kable(df)
```
TO DO: fill in set of monitoring scenarios when we have decided what they are.

TO DO: figure out disturbance forecast scenarios. Can lift Mississa scenario from caribouMetrics paper. Get Churchill scenario from Colin's Lac Seul model with roads - can lift it from the Churchill full model if not easy to sub in Lac Seul. 

TO DO: Fire scenarios? 

## Decision support tool development

Integration into caribouMetrics, shiny UI, integration into SpaDES & SyncroSim.

# Results

## Example figure

```{r scn1, cache=TRUE,echo=FALSE, message=FALSE,results='hide'}
if(runScenarios){
  numObsYrs=c(2);startsByYr = 30 #25
  scns=expand.grid(P=numObsYrs,sQ=c(0.5),st=startsByYr)
  scResults = runScenario(scns)

  png(here::here("analysis/figures/Figure1_Example.png"),
    height = 4, width = fig_widths["mid"], units = "in",res=600)
  print(plotRes(scResults$rr.summary.all, "Female population size",obs=scResults$obs.all,
              lowBound=0,highBound=2000,facetVars=c("P","sQ")))
  dev.off()
}

```

```{r fig1, fig.cap="Example figure.", cache=TRUE}
knitr::include_graphics(here::here("analysis/figures/Figure1_Example.png"))

```



# Acknowledgements

<!-- The following line inserts a page break  -->

\newpage

# References

<!-- The following line ensures the references appear here for the MS Word or HTML output files, rather than right at the end of the document (this will not work for PDF files):  -->

::: {#refs}
:::

\newpage

# Appendix


\newpage

### Colophon

This report was generated on `r Sys.time()` using the following computational environment and dependencies:

```{r colophon, cache = FALSE}
# which R packages and versions?
if ("devtools" %in% installed.packages()) devtools::session_info()
```

The current Git commit details are:

```{r}
# what commit is this file at? 
if ("git2r" %in% installed.packages() & git2r::in_repository(path = ".")) git2r::repository(here::here())  
```
