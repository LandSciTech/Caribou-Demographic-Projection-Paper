---
title: "National demographic-disturbance relationships and local monitoring both reduce uncertainty in projections of boreal caribou population viability: tools to support monitoring decisions"
author:
  - name: Josie Hughes
    email: josie.hughes@ec.gc.ca
    institute: [ECCC]
    correspondence: true
  - name: Sarah Endicott
    email: sarah.endicott@ec.gc.ca
    institute: [ECCC]
    correspondence: false
  - name: Cheryl A Johnson
    email: cheryl-ann.johnson@ec.gc.ca
    institute: [ECCC]
    correspondence: false
  - name: Anna M Calvert
    email: anna.calvert@ec.gc.ca
    institute: [ECCC]
    correspondence: false
institute:
  - ECCC: Environment and Climate Change Canada 
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
    bookdown::word_document2:
      fig_caption: yes
      number_sections: no
      reference_docx: "../templates/template.docx" # Insert path for the DOCX file
      pandoc_args:
      - --lua-filter=../templates/scholarly-metadata.lua
      - --lua-filter=../templates/author-info-blocks.lua
      - --lua-filter=../templates/pagebreak.lua
bibliography: CaribouDemographicModel.bib
csl: "../templates/journal-of-forest-ecology-and-management.csl" # Insert path for the bib-style
abstract: |
  Across fifty-eight boreal caribou ranges in Canada, both survival and recruitment decrease with the percentage of the range that is disturbed. However, there is also variation in demographic rates among ranges, particularly where anthropogenic disturbance is low, and this variation leads to uncertainty in projections derived from national disturbance-demographic relationships. Demographic projections derived from local range-specific data are also uncertain because few places have enough long-term monitoring data to characterize local demographic-disturbance relationships. We present a simple Bayesian integrated population model that integrates prior information from national analysis of demographic-disturbance relationships with available local demographic data to reduce uncertainty in population viability projections. We combine this model with methods for simulating local population dynamics and monitoring to show how monitoring requirements depend on landscape condition. Where anthropogenic disturbance is very high or very low, reasonably accurate status projections can be made using only national demographic-disturbance relationships. At intermediate disturbance levels where uncertainty is higher, deploying few collars for more years may be a lower cost option for improving the reliability of status projections relative to more intensive short-term monitoring. We provide an R Shiny interface to enable others to explore the implications of alternative monitoring scenarios, disturbance trajectories, priors, and other model parameters for boreal caribou demographic projections. This tool can help users assess monitoring needs and strategies.

keywords: |
  keyword 1; keyword 2; keyword 3
highlights: |
  These are the highlights. 
editor_options: 
  chunk_output_type: inline
---

<!-- This is the format for text comments that will be ignored during renderings. Do not put R code in these comments because it will not be ignored. -->

<!-- With the following code you can access and display values from the yml header above. -->
<!-- Link to data here: https://drive.google.com/file/d/179lw6MPK4l3xGmded9kofzJkB6VlJVb9/view?usp=sharing -->

Keywords: `r rmarkdown::metadata$keywords`

Highlights: `r rmarkdown::metadata$highlights`

<!-- The following code chunk defines some general settings how code chunks should behave. -->

```{r setup, echo = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  echo = FALSE,
  comment = "#>",
  fig.path = "../figs/",
  dpi = 300
)
```

<!-- The actual document text starts here: -->
# Introduction

NOTE: find working version of intro and discussion [here:] (https://docs.google.com/document/d/1RD7bJ6yhtBJULjJFRJfHzObQscteyObM/edit?usp=sharing&ouid=111541730342945675365&rtpof=true&sd=true).

Motivating example - forecasting impacts of disturbance - WBI and RoF example. In order to reduce uncertainty, need to integrate local information on current state of the population into forecasts.

Lots of variability among caribou ranges in monitoring data: recency, duration, types of data. E.g. 27+ consecutive years of both telemetry-survival and calf/cow-ratios in most Alberta ranges, vs. 1-4 years of data in most Ontario ranges (and that's old) *note we may want to be careful about inter-province comparisons for political reasons, but the variation is super relevant when to-date we've had the same 'rules' apply across the board... 

In Missisa (and other places, esp Ontario) available local data are old and limited. Not clear how indicative older data is of state of population. Need new data to resolve questions, but what type, how much is enough. Can't monitor in great detail everywhere all the time. More generally, need for tools to help assess the value of additional monitoring and the best way to invest additional monitoring resources, given the info that is already available. 

Topics of interest, questions, goals:

* How get a demographic forecast informed by local demographic data and national disturbance-demographic relationships?
* How to assess the value of collecting additional demographic data? How to prioritize whether to e.g. monitor many areas for a short time or fewer areas over the long term? 
* How much of a bias/misinterpretation can be (has been?) incurred if we don't recognize local differences?
* How does that value depend on current status of the range, available existing demographic data, and projected future disturbance. When and why is more information required, and when do we know enough?
* Provide decision support tools to enable others to get forecasts informed by their local data and national models, and assess the value of monitoring scenarios. 

# Methods

```{r setup2}
library(ggplot2)
library(dplyr)
library(stringr)
library(tidyr)
library(purrr)
library(ggpubr)
library(MetBrewer)
library(here)
library(tmap)
library(sf)

devtools::load_all(here::here())

#set paths
data_path_raw <- "analysis/data/raw_data/"
data_path_drvd <- "analysis/data/derived_data"

pal_nm <- "Redon"

fig_widths <- c(min = 1.18, single = 3.543, mid = 5.51, two = 7.48)

runScenarios = F 
doPriorCalibration=F #Note the prior calibration is time consuming. 
```

## Caribou population monitoring: survival and recruitment metrics

Marking of caribou cows with telemetry GPS/VHF collars is the traditional approach to estimating demographic parameters (refs/examples, e.g. key boreal caribou projections and status documents reliant on these ests, also methods papers like Courtois et al. 2003, RettieMessier 1998). 

Adult survival is estimated by tracking the fate of marked individuals (Kaplan-Meier ests) [brief description of field/logistical details - can get details from NBCKC Telemetry writeup (https://www.cclmportal.ca/sites/default/files/2021-10/Telemetry%20draft%20October%2027%202021.pdf), e.g. GPS allow for remote detection vs VHF-only require physical relocation of individual; collar sends out a
mortality signal when no longer active after a predetermined period of time; males only occasionally collared; age of collared individuals is usually unknown]

Collared females are also used in traditional estimates of recruitment (refs/examples): collared individuals are located by aircraft and then the entire group of caribou is surveyed to estimate the ratio of cows:calves in the group... Because this estimate is based on more than just the collared sample of cows, the sample size for recruitment ests is typically larger than for survival (introduce the multiplier parameter).

## Anthropogenic disturbance and monitoring scenarios

```{r monitoringScenarios, echo=FALSE,message=FALSE}

source(here::here("analysis/scripts/formatScenarios.R"))

knitr::kable(tbl,caption="Monitoring scenarios parameters and values.")
```

```{r figDisturbance, fig.cap="Anthropogenic disturbance and monitoring scenarios.", cache=TRUE}
knitr::include_graphics(here::here("figs/forPaper/distScnscmult6ay3aSf1.png"))

```

For this investigation we assume collars are deployed in January, and last for up to 6 years. The target number of collared females $n$ varies among scenarios, as does the total duration of the monitoring program (Table \@ref(tab:monitoringScenarios)). Collars lost to mortality may be replaced each year ($o=1$), or there may be a 3 year gap between deployments ($o=4$). 

*Monitoring WG input from BC, ON, NL, (MB pending): lots of detail provided but generally those numbers suggest we could try values of ~3-10 [e.g. 3,6,9?] for the cow multiplier, 5-50 for collars [e.g. 5,10,20,40,60?], [not sure about renewal interval, but see SaraM email for some insights]. We know (e.g. from the MonitoringWG perspectives report/update to Rettie summary) that number of years of monitoring can be as low as 2 or as many as 20+

*from Anna: withouot access to actual estimates of R and S for different ranges, some potentially interesting other ranges to compare to could be an Alberta range or two, where there are ++years of R and S estimates but really low lambda (E.g. ESAR and WSAR have 27+ yrs consecutive monitoring but declining numbers and high disturbance), some sections of NWT1 that are thought to be self-sustaining and have pretty good data sets (e.g. Dehcho North and South, Hay River Lowlands with 13+yrs of S and R) -could also use other MB ranges as examples for fairly sparse data (though not as bad as ON), and QC or LAB ranges as examples of good data (e.g. how about Charlevoix for a very well monitored but tiny pop, northern QC for really broad-expanse pop, or Labrador pops have long term monitoring data but uncertain status...)

*feedback from MonitoringWG contacts includes details on collar numbers for BC, ON, NL, (MB pending); e.g. in Ontario they aim for 20-30 collars in smaller pops, 35+ in bigger pops; Labrador aims to have between 5-25 collars monitored at any one time, depending on pop size; in BC, real numbers of collared animals have ranged been between 3-59 per pop/year, varying both across-yrs-within-pop and across-pop-within-yr [with COVID yrs by far the lowest].

relevant refs: [@rettie_summary_2017];?

TO DO: Fire scenarios? Add high fire scenario in appendix of one by one sensitivity checks.

TO DO: run low initial population size scenario, put in appendix of one by one sensitivity checks? 

## Simulation of local population dynamics and monitoring

### Population dynamics informed by national disturbance-demographic relationships

```{r exampleTrajectories, fig.cap="Examples of simulated population trajectories from a model informed only by national disturbance-demographic relationships with (top row) and without (bottom row) delayed reproduction. White dots show means of 500 example trajectories. For reference, black lines and and shaded bands show means and 95\\% predictive intervals from Johnson et al's (2020) regression models without adjustment for misidentification bias and delayed reproduction.", cache=TRUE}

knitr::include_graphics(here::here("analysis/paper/figs/DemographicRatesDelay.png"))

```

To simulate plausible plausible demographic trajectories for example populations we used a modified version of Johnson et al's [-@johnson_science_2020] two-stage demographic model described by Dyson et al. [-@dyson_existing_2022]. The true number of post-juvenile females that survive from year $t$ to the census $\dot{W}_t$ is binomially distributed with true survival probability $\dot{S}_t$: $\dot{W}_{t} \sim \text{Binomial}(\dot{N}_t,\dot{S}_t)$. Maximum potential recruitment rate is adjusted for sex ratio, misidentification biases (Appendix X) and (optionally) delayed age at first reproduction $$\dot{X}_t=\frac{c\dot{R}_t/2}{1+c\dot{R}_t/2};c=\frac{w(1+qu-u)}{(w+qu-u)(1-z)}, $$
where $w$ is a multiplier that defines the apparent number of adult females in the composition survey as a function of the number of collared animals, $q$ the ratio of young bulls to adult females, $u$ is the probability of misidentifying young bulls as adult females and vice versa, and $z$ is the probability of missing a calf.

Realized recruitment rate varies with population density [@lacy_vortex_2017], and the number of juveniles recruiting to the post-juvenile class at the census is a binomially distributed function of the number of surviving post-juvenile females and the adjusted recruitment rate: $$\dot{J}_{t} \sim \text{Binomial}(\dot{W}_t,\dot{X}_t[p_0-(p_0-p_k)(\frac{\dot{W}_t}{N_0k})^b]\frac{\dot{W}_t}{\dot{W}_t+a}).$$ Given parameters in Table X, recruitment rate is lowest $(0.5\dot{X}_t)$ when $\dot{N}_t=1$, approaches a maximum of $\dot{X}_t$ at intermediate population sizes, and declines to $0.6\dot{X}_t$ as the population reaches carrying capacity of $k=100$ times the initial population size. The post-juvenile female population in the next year includes both survivors and new recruits: $\dot{N}_{t+1}=\text{min}(\dot{W}_t+\dot{J}_t,r_{max}\dot{N}_t)$.

Interannual variation in survival and recruitment is modelled using truncated beta distributions [rtrunc function; @novomestky_package_2016]: $\dot{R}_t \sim \text{TruncatedBeta}(\bar{R}_t,\nu_R,l_R,h_R); \dot{S}_t \sim \text{TruncatedBeta}(\bar{S}_t,\nu_S,l_S,h_S)$. Coefficients of variation among years $(\nu_R,\nu_S)$ and maximum/minimum values $l_R,h_R,l_S,h_S$ for recruitment and survival are given in Table X. Expected recruitment ($\bar{R}_t$) and survival ($\bar{S}_t$) vary with disturbance according the beta regression models estimated by Johnson et al. [@johnson_science_2020]: $$ \bar{R}_t \sim Beta(\mu^R_t,\phi^R);log(\mu^R_t)=\dot{\beta^R_0}+\dot{\beta^R_a}A_t+\dot{\beta}^R_fF_t,$$
$$\bar{S}_t \sim (46\times Beta(\mu^S_t,\phi^S)-0.5)/45;log(\mu^S_t)=\dot{\beta^S_0}+\dot{\beta^S_a}A_t.$$
$\phi^R \sim \text{Normal}(19.862,2.229)$ and $\phi^S \sim \text{Normal}(63.733,8.311)$ are precisions of the Beta distributed errors [@ferrari_beta_2004]. At the beginning of a simulation for an example population, regression coefficient values are sampled from Gaussian distributions (see Table \@ref(tab:priors)) and the population is assigned to quantiles of the Beta error distributions for survival and recruitment. The population remains in these quantiles as disturbance changes over time, so there is substantial persistent variation in recruitment and survival among example among populations (Figure \@ref(fig:exampleTrajectories)). 


### Observed survival of collared animals

In our simulated populations, mortality risk does not vary over time or among individuals, so the observed state (dead or alive) of a collared animal $i$ in month $m$ and year $t$ depends on the true survival rate $\dot{S}_t$ (eq X) as follows: 
$$\hat{I}_{i,t,m} \sim \text{Bernoulli}(\dot{S}^{1/12}_t\hat{I}_{i,t,m-1}).$$

### Observed recruitment from composition surveys

The number of cows in the composition survey $\hat{W}_t$ is given by the number of collared cows $\hat{T}_t$ and the apparent number of adult females per collared female calves observed in the composition survey $w$: 
$$\hat{W}_t = w\hat{T}_t.$$
The number of observed calves $\hat{J}_t$ also depends on the unadjusted apparent recruitment for the population $\dot{R}_t$:
$$\hat{J}_t \sim \text{Binomial}(\hat{W}_t,\dot{R}_t).$$

## Integration of local demographic data and national disturbance-demographic relationships in a Bayesian population model

Following Eacker et al. [-@eacker_web-based_2019], the observed number of calves $\hat{J}_t$ is a binomially distributed function of the observed number of adult female caribou $\hat{W}_t$ and the estimated recruitment rate $R_t$: $$\hat{J}_t \sim \text{Binomial}(\hat{W}_t,R_t).$$

We model recruitment probability as a function of anthropogenic disturbance and fire with a log link [@johnson_science_2020;@stewart_climate-informed_nodate;@dyson_existing_2022] and Gaussian distributed random year effect [@eacker_web-based_2019]: $$\log(R_t)=\beta^R_0+\beta^R_a A_t+\beta^R_f F_t+\epsilon^R_t; \epsilon^R_t \sim \text{Normal}(0,\sigma^2_{R}).$$ 
Estimated recruitment probability is adjusted for sex ratio, misidentification biases (Appendix X), and (optionally) age of first reproduction [@eacker_web-based_2019;@decesare_estimating_2012] to get expected recruits per female:
$$X_t=\frac{cR_t/2}{1+cR_t/2}.$$
To maintain consistency with Johnson et al. [-@johnson_science_2020] we also provide an option to only adjust for sex ratio and misidentification biases $X_t=cR_t/2$.

The composition survey bias correction term $c$ depends on the apparent number of adult females per collared animal $w$, the ratio of young bulls to adult females $q$, the probability of misidentifying young bulls as adult females and vice versa $u$, and the probability of missing a calf $z$ (Appendix X):
$$c=\frac{w(1+qu-u)}{(w+qu-u)(1-z)}$$
In the Bayesian model, prior uncertainty about the value of the bias correction term $c$ is approximated with a Log-normal distribution (Appendix X). Given the apparent number of adult females per collared animal $w$ in each monitoring scenario (Table \@ref(tab:monitoringScenarios)), we calculate the mean and standard deviation of 10,000 samples of $\log{c}$ assuming the ratio of young bulls to adult females $q$ varies uniformly between 0 and 0.6, the adult misidentification probability $u$ varies uniformly between 0 and 0.2, and the probability of missing a calf $z$ varies uniformly between 0 and 0.2.

Also following [@eacker_web-based_2019], Kaplan-Meier estimates of observed adult female survival probability $\hat{S}_t$ and associated precisions $\tau_t$ are estimated from known-fate radio collar data using the survival R package [@therneau_modeling_2000], with precisions for years with no observed mortality estimated using a separate Bayesian model. Observed estimated survival is a Gaussian distributed function of the true survival probability: $$\hat{S_t} \sim \text{Normal}(S_t,1/\tau_t).$$ 
We model true survival probability as an adjusted function of buffered anthropogenic disturbance $A_t$ with a log link [@johnson_science_2020;@stewart_climate-informed_nodate;@dyson_existing_2022] and Gaussian distributed random year effect [@eacker_web-based_2019]: $$S_t=\text{min}(46 \tilde{S_t}-0.5)/45,1); \log(\tilde{S_t})=\beta^S_0+\beta^S_a A_t+\epsilon^S_t; \epsilon^S_t \sim \text{Normal}(0,\sigma^2_{S}).$$ 
To assess sensitivity of results to the survival estimation method, we also implemented an alternative parametric exponential survival model, wherein the observed state (alive or dead, $\hat{I}_{i,t,m}$) of an individual animal $i$ in year $t$ and month $m$ is Bernoulli distributed (ref IPM book): $$\hat{I}_{i,t,m} \sim \text{Bernoulli}(S^{1/12}_t\hat{I}_{i,t,m-1}).$$

All regression coefficients are assumed to be Gaussian distributed, with priors derived from the expected values and 95% confidence intervals estimated by Johnson et al (2020) (Table \@ref(tab:priors)). We calibrated the prior distributions so that the 95% prior prediction intervals for survival and recruitment from the Bayesian model match the range between the 2.5% and 97.5% quantiles of 1000 simulated survival and recruitment trajectories (Appendix A, Figure \@ref(fig:examplePredictions)).  

```{r priors, echo=FALSE,message=FALSE}

source(here::here("analysis/scripts/formatPriors.R"))

knitr::kable(tbl,caption="Prior means and standard deviations of Gaussian distributed survival and reproduction model parameters.")
#TO DO: indicate which of these are from Johnson, and which are calibrated.
```

```{r examplePredictions, fig.cap="Prior (top row) and posterior (bottom row) predictions from the Bayesian model for an example population trajectory. In this example scenario anthropogenic disturbance increases by 2\\% per year from 0 to 100\\%. The population is monitored for 15 years with 30 collars per year, and 6 cows per collared cow in the composition surveys. The prior means and 95\\% predictive intervals (top row, orange lines and shading) are similar to the means and ranges between the 2.5\\% and 97.5\\% quantiles of 3000 simulated survival and recruitment trajectories from the national model (top row, blue lines and shading). Local population data (open triangles) reduces uncertainty (bottom row), but when disturbance is very high local data is not required to predict viability (population growth < 1).", cache=TRUE}

knitr::include_graphics(here::here("analysis/paper/figs/bayesianModelExamples.png"))

```

We assume a simple two-class demographic model, with a census in late winter of surviving females and new recruits to the post-juvenile (aged 1+) class. The number of post-juvenile females that survive from year $t$ to the census $W_t$ is binomially distributed with survival probability $S_t$: $W_{t} \sim \text{Binomial}(N_t,S_t)$. The number of juveniles recruiting to the post-juvenile class at the census is a Poisson distributed function of the number of surviving post-juvenile females and the adjusted recruitment rate $X_t$: $J_{t} \sim \text{Poisson}(X_tW_t)$. The post-juvenile female population in the next year includes both survivors and new recruits: $N_{t+1}=W_t+J_t$. Annual population growth rate $\lambda_t$ is set to 0 when $N_t$ is 0, and is otherwise $\lambda_t=N_{t+1}/N_t$. For more stable estimates of population status, we report average population growth over a period of $y$ years, calculated as $\bar{\lambda}_{y,t}=\sum_{x=t-y+1}^{x=t}\lambda_x$. The initial post-juvenile population size $N_0$ is 1000 animals. For reference, all variables and parameters are defined in Table A1. 

$$J_{t} \sim \text{Poisson}(W_tR_t/2)$$
<!--
Annotated equations for poster.
$$\underbrace{N_{t+1}}_{\text{Adult females in year t+1}}=\underbrace{W_t}_{\text{Surviving adults}}+\underbrace{J_t}_{\text{New recruits to adult age class}}$$
$$W_{t} \sim \text{Binomial}(N_t,\underbrace{S_t}_{\text{Adult survival probability}})$$
$$S_t=\underbrace{\text{min}(46 \tilde{S_t}-0.5)/45,1); \log(\tilde{S_t})}_{\text{Adjustment as in in Johnson et al. 2020}}=\beta^S_0+ \underbrace{\beta^S_aA_t}_{\text{Anthropogenic disturbance effect}}+\underbrace{\epsilon^S_t}_{\text{Random effect of year}}.$$
$$J_{t} \sim \text{Poisson}(W_t\underbrace{R_t/2}_{\text{Recruitment rate}})$$
$$\log(R_t)=\beta^R_0+\underbrace{\beta^R_a A_t}_{\text{Anthropogenic disturbance effect}}+ \underbrace{\beta^R_fF_t}_{\text{Fire effect}}+\underbrace{\epsilon^R_t}_{\text{Random effect of year}}.$$
$$\underbrace{\hat{C}_t}_{\text{Observed calves}} \sim \text{Binomial}(\underbrace{\hat{W}_t}_{\text{Observed cows}},R_t)$$
$$\underbrace{\hat{S_t}}_{\text{Observed survival (Kaplan-Meier estimate)}} \sim \text{Normal}(S_t,1/\tau_t).$$ -->

TO DO: 
* note distribution of random effect parameters are truncated to ensure R and S remain within reasonable bounds (not guaranteed given log link). Not yet documented here.
* note Eacker survival method gives biased results in years when <12 months of survival data is available.
* Note I am dropping survival information for animals that are not alive at the beginning of a year to deal with censoring issues. There is probably some more elegant way to deal with this, but it won't make any difference as long as the collar deployment month is set to 1.
* add references to documentation of popGrowthJohnson and other caribouMetrics functions.
* consider & comment on alternative choices made in this example https://poissonconsulting.shinyapps.io/bboushiny/. Follow Eacker example in all particulars, change some aspects, or do comparisons?
* Ensure notation consistency amongst manuscript, UI, documentaiton and code where appropriate. 

TO DO: add example trajectory figure

## Probability of correct status assessment


## User interface and open, flexible, reuseable implementation

Integration into caribouMetrics, shiny UI, integration into SpaDES & SyncroSim.

# Results

```{r figStatusErrors, fig.cap="The probability of a correct status assessment varies with the amount of anthropogenic disturbance (columns), the number of years projected (rows), and monitoring effort (see Figure 1 for scenarios). Probabilities are calculated for 200 example population trajectories (see example trajectories in Figure 2). For each example population, the status assessment is correct if the the Bayesian posterior mean and the true population growth rate are both less than or greater than one. When disturbance is very high the probability of correct status assessment is high even without local monitoring. Where disturbance is moderate, increasing the number of years of monitoring and the number of collars reduces uncertainty, but there are diminishing returns on additional monitoring as sample size increases.", cache=TRUE}
knitr::include_graphics(here::here("figs/forPaper/powercmult6ay3aSf1.png"))
```


# Discussion

Will need a section on the fundamental assumptions of these models/aspatial nature of them, e.g. that collared cows  and cows observed in surveys are a random representative sample of the larger population, and that there is full mixing in the population so that estimated survival/recruitment rates apply equally to all animals in the population. We can discuss this with some contrasting examples, e.g. collaring 30 animals from a very small/restricted population (like Little Smoky, 308,606ha, pop size estimate 78 as of COSEWIC 2014) would likely be much more representative of the population vs. collaring 30 animals from a relatively large/expansive population (northern Quebec range Q6, 62,156,186 ha, pop size 9000 as of COSEWIC 2014). But because of the way this model is built, we assume that the sample is equally representative in either of those cases, so changing the initial starting N won't affect model performance/predictions much here... 

On a related topic to population size; Note that the stuff we got from ArtR regarding simulations for sample size does acknowledge that pops of different sizes have different monitoring requirements, and Sara's Labrador numbers also show targets relative to pop size... Since this kind of aspatial model will mostly be using small population sizes in order to see any effects, we'll jsut have to acknowledge that a caveat of this is that we're not fully able to explore all the population size effects with this model, but generally Josie has found little impact of initial population size to the results. 

We should likely also have a pgph about costs of monitoring - it'll be pretty short, cause basically we have no idea what it costs since nobody will tell us :) Through the NBCKC Monitoring Working Group work, we tried over and over to get some basic cost estimates from P/T reps and practitioners, and hit a wall - nobody wanted to tell us a thing. Don't know if we'd now find anyone is more open to sharing, but don't think we should get our hopes up. But at the very least we'll want to acknowledge that we haven't accounted for relative costs of monitoring... [e.g. costs outlined in the Telemetry guidance report from the MonitoringWG: "Expenses to consider in radio-collared monitoring will vary, based on: helicopter (or other aircraft) use, purchase of tracking collars, data fees associated with the collars (the cost of which varies by operating system, recording frequency and data transmission frequency), and live-capture equipment (3 or more sets of capture nets and associated buckets, a netting gun, and ankle hobbles)"]
-->perhaps the keen MonitoringWG contacts would be willing to provide even really rough cost estimates, and/or even jsut a relative sense of how different it would be to e.g. monitor a few pops for many yrs vs lots of pops for a short time...?




# Acknowledgements

<!-- The following line inserts a page break  -->

\newpage

# References

<!-- The following line ensures the references appear here for the MS Word or HTML output files, rather than right at the end of the document (this will not work for PDF files):  -->

::: {#refs}
:::

\newpage

# Appendix
##Definitions of variables and parameters in the Bayesian population model

Table A1. Variables and parameters in the Bayesian population model and the national demographic model.

|**Symbol**|**Units**|**Description**|
|:-----|-----|:-----------|
|**Indices & constants**|
|$t$|year|Year.|
|$m$|month|Month.|
|$i$|ID|Individual animal identifier.|
|**Observed**|
|$A_t$|%|Buffered anthropogenic disturbance.|
|$F_t$|%|Fire disturbance.| 
|$\hat{J}_t$|animals|Calves observed in calf:cow survey.|
|$\hat{W}_t$|animals|Cows observed in calf:cow survey.|
|$\hat{T}_t$|animals|Number of collared cows.|
|$\hat{S}_t$|probability|Kaplan-Meier estimate of observed adult female survival.|
|$\tau_t$||Precision of Kaplan-Meier survival estimate.|
|$\hat{I}_{i,t,m}$|0 or 1|Indicator of whether animal $i$ is dead or alive.|
|**Estimated state**|
|$R_t$|rate|Recruitment (calves per cow).|
|$S_t$|probability|Adult female survival.|
|$N_t$|animals|Adult female population size.|
|$\bar{\lambda}_{y,t}$|rate|Average population growth over $y$ years.|
|$X_t$|rate|Recruitment adjusted for sex ratio and (optionally) delayed age of first reproduction.|
|$W_t$|animals|Surviving adult females before recruitment.|
|$J_t$|animals|New recruits to adult age class.|
|$\lambda_t$|rate|Annual population growth.|
|**Estimated Parameters**|
|$\beta^R_0$||Recruitment intercept.|
|$\beta^R_a$||Anthropogenic disturbance slope for recruitment.|
|$\beta^R_f$||Fire slope for recruitment.|
|$\sigma^2_{R}$||Variance in random effect of year on recruitment.|
|$\beta^S_0$||Survival intercept.|
|$\beta^S_a$||Anthropogenic disturbance slope for survival.|
|$\sigma^2_{S}$||Variance in random effect of year on survival.|
|**True state**|
|$\dot{R}_t$|rate|Recruitment (calves per cow).|
|$\dot{S}_t$|probability|Adult female survival.|
|$\dot{N}_t$|animals|Adult female population size.|
|$\dot{X}_t$|rate|Recruitment adjusted for sex ratio and (optionally) delayed age of first reproduction.|
|$\dot{W}_t$|animals|Surviving adult females before recruitment.|
|$\dot{J}_t$|animals|New recruits to adult age class.|
|**True demographic parameters**|
|$N_0$|animals|Initial adult population size.|
|$\dot{\beta}^R_0$||Recruitment intercept.|
|$\dot{\beta}^R_a$||Anthropogenic disturbance slope for recruitment.|
|$\dot{\beta}^R_f$||Fire slope for recruitment.|
|$\dot{\beta}^S_0$||Survival intercept.|
|$\dot{\beta}^S_a$||Anthropogenic disturbance slope for survival.|
|$p_0=1$||Maximum recruitment multiplier.|
|$p_k=0.6$||Recruitment multiplier at carrying capacity.|
|$k=100$||Carrying capacity multiplier.|
|$b=4$||Density dependence shape parameter.|
|$a=1$||Allee effect parameter.|
|$r_{max}=1.3$||Maximum population growth rate.|
|$\nu_R=0.46$||Coefficient of variation in $\dot{R}_t$ among years.|
|$\nu_S=0.08696$||Coefficient of variation in $\dot{S}_t$ among years.|
|$l_R=0$||Minimum value for $\dot{R}_t$.|
|$l_S=0$||Minimum value for $\dot{S}_t$.|
|$h_R=0$||Maximum value for $\dot{R}_t$.|
|$h_S=0$||Maximum value for $\dot{S}_t$.|
|**Observation model parameters**|
|$d=1,2,4,8,16, \text{ or } 24$|years|Monitoring duration.|
|$n=15,30, \text{ or } 60$|animals|Target number of collared females.|
|$o=1 \text{ or } 4$|years|Years between collar deployments.|
|$y=3$|years|Assessment period for population growth rate.|
|$w=3,6,\text{ or } 9$|ratio|The apparent number of adult females per collared animal in composition survey.|
|$q=\text{uniform}(0,0.6)$|ratio|True ratio of young bulls to adult females in composition survey.|
|$u=\text{uniform}(0,0.2)$|probability|Probability of misidentifying young bulls as adult females and vice versa in composition survey.|
|$z=\text{uniform}(0,0.2)$|probability|Probability of missing calves in composition survey.|
|$c=\frac{w(1+qu-u)}{(w+qu-u)(1-z)}$||Bias correction term (Appendix X).|

## Model of bias in recruitment estimates from calf:cow surveys

TO DO: get photo of calf:cow survey group. Label classes of animals to illustrate meaning of T, U, V, W, O, P, J, K.

We assume each group of animals in a calf:cow composition survey contains one or more collared adult females ($T$), and may also include: uncollared adult females misidentified as young bulls or unknown sex ($U$); correctly identified uncollared adult females ($V$); young bulls correctly identified as male or unknown sex ($O$); young bulls misidentified as uncollared adult females ($P$); observed calves ($J$); and unobserved calves ($K$). The apparent number of adult females in the group is $T+V+P=Tw$, where $w$ is a multiplier that defines the apparent number of adult females as a function of the number of collared animals. The ratio of young bulls to uncollared adult females in the group is:
$$q = \frac{P+O}{U+V}.$$
Assuming an equal probability $u$ of misidentifying young bulls as adult females and vice versa, we get $V=(U+V)(1-u)$ and $P=(O+P)u$. Given a probability $z$ of missing calves, we get $J=(J+K)(1-z)$.

Our objective is to model the sex and bias-corrected recruitment rate $X=\frac{J+K}{2(T+U+V)}$ as a function of the observed calf:cow ratio $R=J/(T+V+P)$, the cow multiplier $w$, the ratio of young bulls to adult females $q$, and the misidentification probabilities $u$ and $z$. We start by solving for $T+U+V$ as a function of $q,w,u$ and $T$. Recognize that $P=Tw-T-V$, $U+V=V/(1-u)$, and $P+O=P/u$ to write $q$ as 
$$q=\frac{Tw-T-V}{uV/(1-u)}.$$
Rearrange to get 
$$V=\frac{T(w-1)(1-u)}{qu+1-u}.$$
Recognize that $U=Vu/(1-u)$ to write $T+U+V$ as a function of $q,w,u$ and $T$: 
$$T+U+V=T\frac{qu+w-u}{qu+1-u}.$$
Recognize that the number of observed calves $J$ is the product of the apparent recruitment rate and the apparent number of adult females $J=RTw$, and that therefore $J+K=RTw/(1-z)$ to rewrite the bias corrected recruitment rate $X=\frac{J+K}{2(T+U+V)}$ as a function of $w,u,z$ and $R$:
$$X=R\frac{w(1+qu-u)}{2(w+qu-u)(1-z)}.$$
For simplicity, we write $X$ as a function of a bias correction term $c$: 
$$c=\frac{w(1+qu-u)}{(w+qu-u)(1-z)}; X=cR/2$$

If we also adjust for delayed age at first reproduction (DeCesare et al. 2012; Eacker et al. 2019), the adjusted recruitment rate becomes $$X=\frac{cR/2}{1+cR/2}.$$

```{r biasPlot, fig.cap="Variation in the sex and bias corrected recruitment rate $X$ with the cow multiplier $w$, the ratio of young bulls to adult females $q$, and the adult misidentification probability $u$, and the probability of missing a calf $z$. If only collared females are counted ($w=1$) and there is a risk of missing calves $z>0$ then the apparent recruitment rate $R$ will be lower than $X$ (first column). When uncollared animals are counted ($w>1$), the risk of misidentifying adults $u$ inflates the apparent recruitment rate $R$ as on average more cows are misidentified as bulls than vice versa, but this effect is smaller than the effect of missing calves $z$. Increasing the proportion of bulls in the group $q$ reduces the effect of adult misidentification $u$.", fig.height=6,cache=TRUE}
library(ggplot2)
#Notes
#q: assume more females than males in calf:cow group, so q<1

p=expand.grid(delay=c(T,F),q=c(0,0.3,0.6),w=c(1,3,6),
              u=c(0,0.1,0.2),z=seq(0,0.2,length.out=3),R=seq(0.15,0.6,length.out=10))

getX<-function(R,delay,q,w,u,z){
  c = compositionBiasCorrection(w,q,u,z)
  X = 0.5*R*c
  X=X*(1-delay)+delay*X/(1+X)
  return(X)
}

p$X = getX(p$R,p$delay,p$q,p$w,p$u,p$z)

p$grp = paste(p$u,p$z)
p$u=as.factor(p$u)
p$z=as.factor(p$z)

base = ggplot(subset(p,!delay),aes(x=R,y=2*X/R,col=z,linetype=u,group=grp))+
  geom_hline(yintercept=1)+geom_line()+facet_grid(q~w,labeller=label_both)+theme_bw()+ylab("2X/R=c, without delayed reproduction")

base2 = ggplot(subset(p,delay),aes(x=R,y=2*X/R,col=z,linetype=u,group=grp))+
  geom_hline(yintercept=1)+geom_line()+facet_grid(q~w,labeller=label_both)+theme_bw()+ylab("2X/R, with delayed reproduction")

ggpubr::ggarrange(base, base2, labels = "",
                  ncol = 1, vjust = 1)

```

```{r biasDistribution, fig.cap="In the Bayesian model, uncertainty about the value of the bias correction term $c$ (grey bars) is approximated with a Log-normal distribution (red). In these examples, the ratio of young bulls to adult females $q$ varies uniformly between 0 and 0.6, the adult misidentification probability $u$ varies uniformly between 0 and 0.2, and the probability of missing a calf $z$ varies uniformly between 0 and 0.2. We assume that the apparent number of adult females per collared animal $w$ is known.", cache=TRUE}

cr=expand.grid(w = c(1,2,3,4,5,6,7,8,9),rep=seq(1,10000))
nr=nrow(cr)
cr$c = compositionBiasCorrection(q=runif(nr,0,0.6),w=cr$w,u=runif(nr,0,0.2),z=runif(nr,0,0.2))
cs = compositionBiasCorrection(q=runif(nr,0,0.6),w=cr$w,u=runif(nr,0,0.2),z=runif(nr,0,0.2),approx=T)

cr = merge(cr,cs)
cr$ca= exp(rnorm(nrow(cr),mean=cr$mu,sd=cr$sig2^0.5))

base = ggplot(cr,aes(x=c))+geom_histogram(aes(y=..density..))+
  facet_wrap(~w,nrow=3,labeller=label_both)+theme_bw()+
  geom_density(aes(x=ca),alpha=.2, fill="#FF6666",col = "#FF6666")
plot(base)

```


## Calibration of Priors

```{r priorCalibration, cache=TRUE,echo=FALSE, message=FALSE,results='hide'}
if(doPriorCalibration){

  source(here::here("analysis/scripts/calibratePriors.R"))
}else{
  KS<-read.csv(here::here("tabs/SurvKSAll.csv"))
  KSRec<-read.csv(here::here("tabs/RecKSAll.csv"))

}
  #library(ggplot2);fig_widths=data.frame(two=7)
  KS$SigmaMean = KS$sInterannualVar
  KS$SigmaSD = KS$sInterannualVarSE
  KS=subset(KS,scn=="All")
  png(here::here("figs/PriorKSDists.png"),
    height = 3, width = fig_widths["two"], units = "in",res=100)
    base = ggplot(KS,aes(x=sIntSEMod,y=KSDistance,color=SigmaMean))+
    geom_point()+facet_wrap(~SigmaSD,labeller="label_both")+theme_bw()+ylab("Kolmogorov-Smirnov Distance")+xlab("sIntSEMod: multiplier on SD of survival intercept")
    print(base)
  dev.off()

  KSRec$SigmaMean = KSRec$rInterannualVar
  KSRec$SigmaSD = KSRec$rInterannualVarSE
  KSRec=subset(KSRec,scn=="All")
  png(here::here("figs/PriorKSDistsRec.png"),
    height = 3, width = fig_widths["two"], units = "in",res=600)
    base = ggplot(KSRec,aes(x=rIntSEMod,y=KSDistance,color=SigmaMean))+
    geom_point()+facet_wrap(~SigmaSD,labeller="label_both")+theme_bw()+ylab("Kolmogorov-Smirnov Distance")+xlab("rIntSEMod: multiplier on SD of recruitment intercept")
    print(base)
  dev.off()
```

Prior parameter values should be set so that, given no monitoring data, the prior survival distribution is similar to the distribution of simulated outcomes from the national model in the case of no anthropogenic disturbance. This condition is met when the multiplier on the prior standard deviation of the survival intercept (sIntSEMod: $\\beta^S_0$ in Table @ref(tab:priors)) is 5 and the mean and standard deviations of the prior distribution of the random effect of year on survival are low  (SigmaMean & SigmaSD, $\\sigma^2_S$ in Table @ref(tab:priors)) (Figs @ref(fig:priorKSDists) and @ref(fig:priorAllFits)). Priors should also be vague enough so that, given intensive monitoring of populations where survival is higher or lower than the national average ('High' and 'Low' scenarios: 15 years of 60 collars per year from 97.5% and 2.5% quantiles of the national model), posteriors reflect local survival, rather than priors from the national model. Setting the mean and standard deviations of the prior distribution of the random effect of year on survival to moderately low values (SigmaMean=0.034784, SigmaSD=0.03, $\\sigma^2_S$ in Table @ref(tab:priors)) allows both conditions to be met (Figs @ref(fig:priorKSDists), @ref(fig:priorAllFits) and @ref(fig:priorLowFits)).

```{r PriorKSDists, fig.cap="Similarity of the prior survival distribution to the distribution of simulated outcomes from the national model measured by Kolmogorov-Smirnov distance [ks.test function in @R_R_2022]. The distributions are similar when the multiplier on the prior standard deviation of the survival intercept (sIntSEMod: $\\beta^S_0$ in Table @ref(tab:priors)) is 5 and the mean and standard deviations of the prior distribution of the random effect of year on survival are low  (SigmaMean & SigmaSD, $\\sigma^2_S$ in Table @ref(tab:priors)). Anthropogenic disturbance is set to 0 in these scenarios." , cache=TRUE}
knitr::include_graphics(here::here("figs/PriorKSDists.png"))

#TO DO: figure out what to do about citations and references in figure captions. Or just fill them in manually at a later stage.

```

```{r PriorAllFits, fig.cap="Differences between prior predictive survival distributions from the Bayesian model ('local') and simulated outcomes from the national model ('national'), assuming no local monitoring. In these examples, the standard deviation of the random effect prior (SigmaSD: $\\sigma^2_S$ in Table @ref(tab:priors)) is 0.03, and anthropogenic disturbance is 0. Bands show 95% posterior predictive intervals ('local'), and the 2.5th and 97.5th percentiles for 1000 sample populations from the national model.",  cache=TRUE}

knitr::include_graphics(here::here("figs/SurvInterceptAllsInterannualVarSE0.03.png"))
```

```{r PriorLowFits, fig.cap="Posterior predictive survival distributions from the Bayesian model ('local') assuming intensive monitoring (15 years of 60 collars per year) of populations from the 2.5 \\% quantile of the national model. In these examples, the standard deviation of the random effect prior (SigmaSD: $\\sigma^2_S$ in Table @ref(tab:priors)) is 0.03, and  anthropogenic disturbance is 0. Bands show 95 \\% posterior predictive intervals, black dots show true survival rates from the simulated population, and open triangles show observed survival rates. When the multiplier on the prior standard deviation of the survival intercept (sIntSEMod: $\\beta^S_0$ in Table @ref(tab:priors)) is too low (<5) the insufficiently vague priors substantially influence the posterior distributions, yielding poor local parameter estimates.", cache=TRUE}

knitr::include_graphics(here::here("figs/SurvsurvInterceptLowsInterannualVarSE0.03.png"))
```

```{r PriorAllFitsAnthro90, fig.cap="Differences between prior predictive survival distributions from the Bayesian model ('local') and simulated outcomes from the national model ('national'), assuming no local monitoring. In these examples, anthropogenic disturbance is 90\\%. When the multiplier on the prior standard deviation of the survival slope (sSlopeSEMod: $\\beta^S_a$ in Table @ref(tab:priors)) is 3, the posterior survival distribution is similar to the distribution of simulated outcomes from the national model. Bands show 95\\% posterior predictive intervals ('local'), and the 2.5th and 97.5th percentiles for 1000 sample populations from the national model.", cache=TRUE}
knitr::include_graphics(here::here("figs/SurvSlopeAll.png"))
```

```{r PriorHighFitsAnthro90, fig.cap="Posterior predictive survival distributions from the Bayesian model, assuming intensive monitoring (15 years of 60 collars per year) of populations from the 97.5 \\% quantile of the national model. In these examples, anthropogenic disturbance is 90\\%, and the effect of anthropogenic disturbance varies from none (sSlopeMod=0) through expected (sSlopeMod=1) to double the expected slope (sSlopeMod=2). All considered multipliers on the prior standard deviation of the survival slope (sSlopeSEMod: $\\beta^S_a$ in Table @ref(tab:priors)) are sufficiently vague to reflect local variation among populations. Bands show 95 \\% posterior predictive intervals, black dots show true survival rates from the simulated population, and open triangles show observed survival rates.", cache=TRUE}
knitr::include_graphics(here::here("figs/SurvSlopeHigh.png"))
```

Similarly, prior parameter values should be set so that, given no monitoring data, the prior recruitment distribution is similar to the distribution of simulated outcomes from the national model in the case of no anthropogenic disturbance. This condition is met when the multiplier on the prior standard deviation of the recruitment intercept (rIntSEMod: $\\beta^R_0$ in Table @ref(tab:priors)) is 4 and the mean and standard deviations of the prior distribution of the random effect of year on survival are low  (SigmaMean & SigmaSD, $\\sigma^2_R$ in Table @ref(tab:priors)) (Figs @ref(fig:priorKSDistsRec) and @ref(fig:priorAllFitsRec)). Priors should also be vague enough so that, given intensive monitoring of populations where recruitment is higher or lower than the national average ('High' and 'Low' scenarios: 15 years of 9*60 cows per year from 97.5% and 2.5% quantiles of the national model), posteriors reflect local recruitment, rather than priors from the national model. Setting the mean and standard deviations of the prior distribution of the random effect of year on recruitment to moderately low values (SigmaMean=0.23, SigmaSD=0.22, $\\sigma^2_R$ in Table @ref(tab:priors)) allows both conditions to be met (Figs @ref(fig:priorKSDistsRec), @ref(fig:priorAllFitsRec) and @ref(fig:priorLowFitsRec)).

```{r PriorKSDistsRec, fig.cap="Similarity of the prior recruitment distribution to the distribution of simulated outcomes from the national model measured by Kolmogorov-Smirnov distance [ks.test function in @R_R_2022]. The distributions are similar when the multiplier on the prior standard deviation of the survival intercept (rIntSEMod: $\\beta^R_0$ in Table @ref(tab:priors)) is 4 and the mean and standard deviations of the prior distribution of the random effect of year on survival are low  (SigmaMean & SigmaSD, $\\sigma^2_R$ in Table @ref(tab:priors)). Anthropogenic disturbance is set to 0 in these scenarios." , cache=TRUE}
knitr::include_graphics(here::here("figs/PriorKSDistsRec.png"))
```

```{r PriorAllFitsRec, fig.cap="Differences between prior predictive recruitment distributions from the Bayesian model ('local') and simulated outcomes from the national model ('national'), assuming no local monitoring. In these examples, the standard deviation of the random effect prior (SigmaSD: $\\sigma^2_R$ in Table @ref(tab:priors)) is 0.22, and anthropogenic disturbance is 0. Bands show 95% posterior predictive intervals ('local'), and the 2.5th and 97.5th percentiles for 1000 sample populations from the national model.",  cache=TRUE}
knitr::include_graphics(here::here("figs/RecInterceptAllrInterannualVarSE0.22.png"))
```

```{r PriorHighFitsRec, fig.cap="Posterior predictive recruitment distributions from the Bayesian model ('local') assuming intensive monitoring (9*60 cows per year for 15 years) of populations from the 97.5% quantile of the national model.  In these examples, the standard deviation the random effect prior (SigmaSD: $\\sigma^2_R$ in Table @ref(tab:priors)) is 0.22, and  anthropogenic disturbance is 0. Bands show 95% posterior predictive intervals, black dots show true recruitment rates from the simulated population, and open triangles show observed recruitment rates.", cache=TRUE}
knitr::include_graphics(here::here("figs/RecInterceptHighrInterannualVarSE0.22.png"))
```

```{r PriorAllFitsAnthro90Rec, fig.cap="Differences between prior predictive survival distributions from the Bayesian model ('local') and simulated outcomes from the national model ('national'), assuming no local monitoring. In these examples, anthropogenic disturbance is 90\\%. When the multiplier on the prior standard deviation of the recruitment slope (rSlopeSEMod: $\\beta^R_a$ in Table @ref(tab:priors)) is 4, the posterior survival distribution is similar to the distribution of simulated outcomes from the national model. Bands show 95\\% posterior predictive intervals ('local'), and the 2.5th and 97.5th percentiles for 1000 sample populations from the national model.", cache=TRUE}
knitr::include_graphics(here::here("figs/RecSlopeAll.png"))
```

```{r PriorHighFitsAnthro90Rec, fig.cap="Posterior predictive recruitment distributions from the Bayesian model, assuming intensive monitoring (15 years of 60 collars per year) of populations from the 97.5 \\% quantile of the national model. In these examples, anthropogenic disturbance is 90\\%, and the effect of anthropogenic disturbance varies from none (rSlopeMod=0) through expected (rSlopeMod=1) to double the expected slope (rSlopeMod=2). All considered multipliers on the prior standard deviation of the recruitment slope >1 (rSlopeSEMod: $\\beta^R_a$ in Table @ref(tab:priors)) are sufficiently vague to reflect local variation among populations. Bands show 95 \\% posterior predictive intervals, black dots show true survival rates from the simulated population, and open triangles show observed survival rates.", cache=TRUE}
knitr::include_graphics(here::here("figs/RecSlopeHigh.png"))
```

\newpage

### Colophon

This report was generated on `r Sys.time()` using the following computational environment and dependencies:

```{r colophon, cache = FALSE}
# which R packages and versions?
#if ("devtools" %in% installed.packages()) devtools::session_info()
```

The current Git commit details are:

```{r}
# what commit is this file at? 
#if ("git2r" %in% installed.packages() & git2r::in_repository(path = ".")) git2r::repository(here::here())  
```
